<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>HIIT Runner</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0a0e17;
      --bg-secondary: #111827;
      --bg-card: rgba(17, 24, 39, 0.85);
      --border-subtle: rgba(255, 255, 255, 0.06);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;

      --warmup-color: #f59e0b;
      --warmup-glow: rgba(245, 158, 11, 0.25);
      --fast-color: #ef4444;
      --fast-glow: rgba(239, 68, 68, 0.3);
      --slow-color: #3b82f6;
      --slow-glow: rgba(59, 130, 246, 0.25);
      --cooldown-color: #06b6d4;
      --cooldown-glow: rgba(6, 182, 212, 0.25);
      --done-color: #10b981;
      --done-glow: rgba(16, 185, 129, 0.25);

      --accent: var(--warmup-color);
      --accent-glow: var(--warmup-glow);

      --radius: 14px;
      --radius-sm: 10px;
    }

    html {
      height: 100%;
    }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100%;
      min-height: 100dvh;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -webkit-overflow-scrolling: touch;
    }

    /* ── Screen pulse effect ── */
    .pulse-ring {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 90;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .pulse-ring.active {
      animation: screen-pulse 1s ease-in-out 5;
    }

    @keyframes screen-pulse {
      0%   { opacity: 0; box-shadow: inset 0 0 40px 10px var(--pulse-color, #f59e0b); }
      40%  { opacity: 1; box-shadow: inset 0 0 80px 30px var(--pulse-color, #f59e0b); }
      100% { opacity: 0; box-shadow: inset 0 0 40px 10px var(--pulse-color, #f59e0b); }
    }

    /* ── Ambient background ── */
    .bg-glow {
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse 60% 40% at 50% 20%, var(--accent-glow), transparent 70%);
      pointer-events: none;
      z-index: 0;
      transition: background 1s ease;
    }

    /* ── App container ── */
    .app {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      padding: 16px 14px 24px;
      display: flex;
      flex-direction: column;
      min-height: 100dvh;
    }

    /* ── Header ── */
    .header {
      text-align: center;
      margin-bottom: 10px;
      flex-shrink: 0;
    }

    .header h1 {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .header h1 span {
      color: var(--accent);
      transition: color 0.6s ease;
    }

    /* ── Phase strip ── */
    .phase-strip {
      display: flex;
      gap: 5px;
      margin-bottom: 12px;
      flex-shrink: 0;
    }

    .phase-strip-item {
      flex: 1;
      height: 3px;
      border-radius: 2px;
      background: var(--border-subtle);
      transition: background 0.4s, box-shadow 0.4s;
    }

    .phase-strip-item.active {
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent-glow);
    }

    .phase-strip-item.completed {
      background: var(--text-muted);
    }

    /* ── Timer card ── */
    .timer-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius);
      padding: 20px 16px 16px;
      text-align: center;
      backdrop-filter: blur(20px);
      margin-bottom: 10px;
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }

    .timer-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: var(--accent);
      transition: background 0.6s;
    }

    .phase-label {
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--accent);
      transition: color 0.6s;
    }

    .mode-label {
      font-size: 0.65rem;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 8px;
      min-height: 1em;
    }

    .time-display {
      font-family: 'JetBrains Mono', monospace;
      font-size: 4rem;
      font-weight: 700;
      line-height: 1;
      color: var(--text-primary);
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .speed-row {
      display: flex;
      align-items: baseline;
      justify-content: center;
      gap: 6px;
    }

    .speed-val {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.7rem;
      font-weight: 700;
      color: var(--accent);
      transition: color 0.6s;
    }

    .speed-unit {
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-muted);
    }

    .cycle-info {
      margin-top: 6px;
      font-size: 0.7rem;
      font-weight: 500;
      color: var(--text-muted);
      letter-spacing: 0.04em;
    }

    .cycle-info b {
      color: var(--text-secondary);
      font-weight: 600;
    }

    .progress-track {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.04);
      border-radius: 2px;
      margin-top: 12px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 0.3s linear, background 0.6s;
      width: 100%;
    }

    /* ── Controls ── */
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-shrink: 0;
    }

    .btn {
      flex: 1;
      height: 48px;
      min-height: 44px;
      border: none;
      border-radius: var(--radius-sm);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .btn:active { transform: scale(0.97); }

    .btn-primary {
      background: var(--accent);
      color: #0a0e17;
      box-shadow: 0 4px 16px var(--accent-glow);
      transition: background 0.6s, box-shadow 0.6s;
    }

    .btn-primary:hover { filter: brightness(1.1); }

    .btn-secondary {
      background: rgba(255,255,255,0.06);
      color: var(--text-secondary);
      border: 1px solid var(--border-subtle);
    }

    .btn-secondary:hover { background: rgba(255,255,255,0.1); }

    .btn svg { width: 18px; height: 18px; }

    /* ── Settings ── */
    .settings {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius);
      backdrop-filter: blur(20px);
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .settings.disabled {
      opacity: 0.4;
      pointer-events: none;
    }

    .settings-header {
      padding: 10px 16px 8px;
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-subtle);
      flex-shrink: 0;
    }

    .settings-scroll {
      overflow-y: auto;
      flex: 1;
      -webkit-overflow-scrolling: touch;
    }

    .setting-group {
      padding: 6px 14px 8px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .setting-group:last-child { border-bottom: none; }

    .sg-title {
      font-size: 0.62rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .sg-title .dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      display: inline-block;
    }

    .s-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 36px;
    }

    .s-label {
      font-size: 0.78rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .s-ctrl {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .s-ctrl button {
      width: 36px;
      height: 36px;
      min-width: 44px;
      min-height: 44px;
      padding: 0;
      border: 1px solid var(--border-subtle);
      background: rgba(255,255,255,0.04);
      color: var(--text-secondary);
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
    }

    .s-ctrl button:hover {
      background: rgba(255,255,255,0.1);
      color: var(--text-primary);
    }

    .s-ctrl button:active { transform: scale(0.92); }

    .s-val {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text-primary);
      min-width: 38px;
      text-align: center;
    }

    /* ── Completion screen ── */
    .done-screen {
      position: fixed;
      inset: 0;
      z-index: 50;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg-primary);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.6s;
    }

    .done-screen.active {
      opacity: 1;
      pointer-events: auto;
    }

    .done-icon {
      width: 88px;
      height: 88px;
      border-radius: 50%;
      background: var(--done-color);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      box-shadow: 0 0 50px var(--done-glow);
    }

    .done-icon svg { width: 42px; height: 42px; color: #0a0e17; }

    .done-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .done-sub {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 28px;
    }

    .done-stats {
      display: flex;
      gap: 28px;
      margin-bottom: 32px;
    }

    .done-stat { text-align: center; }

    .done-stat-val {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--done-color);
    }

    .done-stat-lbl {
      font-size: 0.68rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* ── Responsive for small screens ── */
    @media (max-height: 640px) {
      .time-display { font-size: 3rem; }
      .timer-card { padding: 14px 14px 12px; }
      .speed-val { font-size: 1.3rem; }
      .s-row { height: 32px; }
    }

    @media (max-height: 540px) {
      .time-display { font-size: 2.5rem; }
      .header { margin-bottom: 6px; }
      .header h1 { font-size: 0.9rem; }
      .phase-strip { margin-bottom: 8px; }
      .timer-card { padding: 10px 12px 10px; margin-bottom: 6px; }
      .controls { margin-bottom: 6px; }
      .btn { height: 42px; font-size: 0.8rem; }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <!-- Screen pulse overlay -->
  <div class="pulse-ring" id="pulseRing"></div>

  <!-- Ambient glow -->
  <div class="bg-glow"></div>

  <div class="app">
    <div class="header">
      <h1>HIIT <span>Runner</span></h1>
    </div>

    <div class="phase-strip">
      <div class="phase-strip-item" id="strip-warmup"></div>
      <div class="phase-strip-item" id="strip-training"></div>
      <div class="phase-strip-item" id="strip-cooldown"></div>
    </div>

    <div class="timer-card">
      <div class="phase-label" id="phaseLabel">Warm Up</div>
      <div class="mode-label" id="modeLabel">&nbsp;</div>
      <div class="time-display" id="timeDisplay">02:00</div>
      <div class="speed-row">
        <span class="speed-val" id="speedDisplay">6.0</span>
        <span class="speed-unit">km/h</span>
      </div>
      <div class="cycle-info" id="cycleInfo" style="display:none;">
        Cycle <b id="curCycle">1</b> / <b id="totCycles">6</b>
      </div>
      <div class="progress-track">
        <div class="progress-fill" id="progressBar"></div>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" id="btnStart">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        Start
      </button>
      <button class="btn btn-secondary" id="btnReset" style="display:none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
        Reset
      </button>
    </div>

    <div class="settings" id="settingsPanel">
      <div class="settings-header">Settings</div>
      <div class="settings-scroll">
        <!-- Warm Up -->
        <div class="setting-group">
          <div class="sg-title">
            <span class="dot" style="background:var(--warmup-color)"></span> Warm Up
          </div>
          <div class="s-row">
            <span class="s-label">Speed</span>
            <div class="s-ctrl">
              <button onclick="adj('warmupSpeed',-0.5)" aria-label="Decrease warm up speed">&minus;</button>
              <span class="s-val" id="v-warmupSpeed">6.0</span>
              <button onclick="adj('warmupSpeed',0.5)" aria-label="Increase warm up speed">&plus;</button>
            </div>
          </div>
          <div class="s-row">
            <span class="s-label">Duration</span>
            <div class="s-ctrl">
              <button onclick="adj('warmupTime',-30)" aria-label="Decrease warm up time">&minus;</button>
              <span class="s-val" id="v-warmupTime">2:00</span>
              <button onclick="adj('warmupTime',30)" aria-label="Increase warm up time">&plus;</button>
            </div>
          </div>
        </div>

        <!-- Training -->
        <div class="setting-group">
          <div class="sg-title">
            <span class="dot" style="background:var(--fast-color)"></span> Training
          </div>
          <div class="s-row">
            <span class="s-label">Fast Speed</span>
            <div class="s-ctrl">
              <button onclick="adj('fastSpeed',-0.5)" aria-label="Decrease fast speed">&minus;</button>
              <span class="s-val" id="v-fastSpeed">12.0</span>
              <button onclick="adj('fastSpeed',0.5)" aria-label="Increase fast speed">&plus;</button>
            </div>
          </div>
          <div class="s-row">
            <span class="s-label">Fast Duration</span>
            <div class="s-ctrl">
              <button onclick="adj('fastTime',-10)" aria-label="Decrease fast time">&minus;</button>
              <span class="s-val" id="v-fastTime">0:30</span>
              <button onclick="adj('fastTime',10)" aria-label="Increase fast time">&plus;</button>
            </div>
          </div>
          <div class="s-row">
            <span class="s-label">Slow Speed</span>
            <div class="s-ctrl">
              <button onclick="adj('slowSpeed',-0.5)" aria-label="Decrease slow speed">&minus;</button>
              <span class="s-val" id="v-slowSpeed">7.0</span>
              <button onclick="adj('slowSpeed',0.5)" aria-label="Increase slow speed">&plus;</button>
            </div>
          </div>
          <div class="s-row">
            <span class="s-label">Slow Duration</span>
            <div class="s-ctrl">
              <button onclick="adj('slowTime',-10)" aria-label="Decrease slow time">&minus;</button>
              <span class="s-val" id="v-slowTime">1:00</span>
              <button onclick="adj('slowTime',10)" aria-label="Increase slow time">&plus;</button>
            </div>
          </div>
          <div class="s-row">
            <span class="s-label">Cycles</span>
            <div class="s-ctrl">
              <button onclick="adj('cycles',-1)" aria-label="Decrease cycles">&minus;</button>
              <span class="s-val" id="v-cycles">6</span>
              <button onclick="adj('cycles',1)" aria-label="Increase cycles">&plus;</button>
            </div>
          </div>
        </div>

        <!-- Cool Down -->
        <div class="setting-group">
          <div class="sg-title">
            <span class="dot" style="background:var(--cooldown-color)"></span> Cool Down
          </div>
          <div class="s-row">
            <span class="s-label">Speed</span>
            <div class="s-ctrl">
              <button onclick="adj('cooldownSpeed',-0.5)" aria-label="Decrease cool down speed">&minus;</button>
              <span class="s-val" id="v-cooldownSpeed">5.0</span>
              <button onclick="adj('cooldownSpeed',0.5)" aria-label="Increase cool down speed">&plus;</button>
            </div>
          </div>
          <div class="s-row">
            <span class="s-label">Duration</span>
            <div class="s-ctrl">
              <button onclick="adj('cooldownTime',-30)" aria-label="Decrease cool down time">&minus;</button>
              <span class="s-val" id="v-cooldownTime">3:00</span>
              <button onclick="adj('cooldownTime',30)" aria-label="Increase cool down time">&plus;</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Completion screen -->
  <div class="done-screen" id="doneScreen">
    <div class="done-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
    </div>
    <div class="done-title">Workout Complete</div>
    <div class="done-sub">Great run. You crushed it.</div>
    <div class="done-stats">
      <div class="done-stat">
        <div class="done-stat-val" id="statTime">--:--</div>
        <div class="done-stat-lbl">Total Time</div>
      </div>
      <div class="done-stat">
        <div class="done-stat-val" id="statCycles">--</div>
        <div class="done-stat-lbl">Cycles</div>
      </div>
    </div>
    <button class="btn btn-primary" onclick="fullReset()" style="width:180px;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
      New Workout
    </button>
  </div>

  <script>
    // ═══════════════════════════════════════════
    //  STATE
    // ═══════════════════════════════════════════
    const S = {
      warmupSpeed: 6.0, warmupTime: 120,
      fastSpeed: 12.0, fastTime: 30,
      slowSpeed: 7.0, slowTime: 60,
      cycles: 6,
      cooldownSpeed: 5.0, cooldownTime: 180,
    };

    const LIM = {
      warmupSpeed:   [2,15],   warmupTime:   [30,600],
      fastSpeed:     [5,25],   fastTime:     [10,300],
      slowSpeed:     [2,15],   slowTime:     [10,300],
      cycles:        [1,30],
      cooldownSpeed: [2,15],   cooldownTime: [30,600],
    };

    let phase = 'idle';
    let timeLeft = 0, totalPhaseTime = 0, curCycle = 0;
    let ticker = null, running = false, t0 = null;

    // ═══════════════════════════════════════════
    //  AUDIO ENGINE
    // ═══════════════════════════════════════════
    let actx = null;
    let activeSoundNodes = []; // track nodes to stop them

    function ctx() {
      if (!actx) actx = new (window.AudioContext || window.webkitAudioContext)();
      if (actx.state === 'suspended') actx.resume();
      return actx;
    }

    function stopAllSounds() {
      activeSoundNodes.forEach(n => { try { n.stop(); } catch(e){} });
      activeSoundNodes = [];
    }

    // ── Continuous morse-dot sound (FAST / sprint) ──
    // Rapid short beeps for 5 seconds, ~100ms on / 60ms off
    function playContinuousFast() {
      stopAllSounds();
      const c = ctx(), now = c.currentTime;
      const dur = 5, onTime = 0.08, gap = 0.06, freq = 880;
      let t = now;
      while (t < now + dur) {
        const o = c.createOscillator();
        const g = c.createGain();
        o.type = 'square';
        o.frequency.value = freq;
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.28, t + 0.01);
        g.gain.setValueAtTime(0.28, t + onTime - 0.01);
        g.gain.linearRampToValueAtTime(0, t + onTime);
        o.connect(g).connect(c.destination);
        o.start(t);
        o.stop(t + onTime + 0.01);
        activeSoundNodes.push(o);
        t += onTime + gap;
      }
    }

    // ── Continuous morse-dash sound (SLOW / recovery) ──
    // Longer tones for 5 seconds, ~300ms on / 200ms off
    function playContinuousSlow() {
      stopAllSounds();
      const c = ctx(), now = c.currentTime;
      const dur = 5, onTime = 0.30, gap = 0.20, freq = 440;
      let t = now;
      while (t < now + dur) {
        const o = c.createOscillator();
        const g = c.createGain();
        o.type = 'sine';
        o.frequency.value = freq;
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.25, t + 0.02);
        g.gain.setValueAtTime(0.25, t + onTime - 0.03);
        g.gain.linearRampToValueAtTime(0, t + onTime);
        o.connect(g).connect(c.destination);
        o.start(t);
        o.stop(t + onTime + 0.01);
        activeSoundNodes.push(o);
        t += onTime + gap;
      }
    }

    // ── Warm-up start: ascending continuous chime for 5s ──
    function playContinuousWarmup() {
      stopAllSounds();
      const c = ctx(), now = c.currentTime;
      const notes = [392, 440, 523.25, 587.33, 659.25]; // G4 A4 C5 D5 E5
      const dur = 5, noteLen = 0.45, gap = 0.15;
      let t = now;
      let idx = 0;
      while (t < now + dur) {
        const o = c.createOscillator();
        const g = c.createGain();
        o.type = 'triangle';
        o.frequency.value = notes[idx % notes.length];
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.22, t + 0.03);
        g.gain.setValueAtTime(0.22, t + noteLen - 0.05);
        g.gain.linearRampToValueAtTime(0, t + noteLen);
        o.connect(g).connect(c.destination);
        o.start(t);
        o.stop(t + noteLen + 0.01);
        activeSoundNodes.push(o);
        t += noteLen + gap;
        idx++;
      }
    }

    // ── Training start (warmup->training): urgent rising sweep 5s ──
    function playContinuousTrainingStart() {
      stopAllSounds();
      const c = ctx(), now = c.currentTime;
      // Repeating short rising sweeps
      const dur = 5, reps = 8;
      const repLen = dur / reps;
      for (let i = 0; i < reps; i++) {
        const t = now + i * repLen;
        const o = c.createOscillator();
        const g = c.createGain();
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(300, t);
        o.frequency.exponentialRampToValueAtTime(900, t + repLen * 0.7);
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.2, t + 0.02);
        g.gain.setValueAtTime(0.2, t + repLen * 0.6);
        g.gain.linearRampToValueAtTime(0, t + repLen * 0.9);
        o.connect(g).connect(c.destination);
        o.start(t);
        o.stop(t + repLen);
        activeSoundNodes.push(o);
      }
    }

    // ── Training->cooldown: descending calm sweeps 5s ──
    function playContinuousCooldownStart() {
      stopAllSounds();
      const c = ctx(), now = c.currentTime;
      const dur = 5, reps = 5;
      const repLen = dur / reps;
      for (let i = 0; i < reps; i++) {
        const t = now + i * repLen;
        const o = c.createOscillator();
        const g = c.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(700, t);
        o.frequency.exponentialRampToValueAtTime(280, t + repLen * 0.8);
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.22, t + 0.03);
        g.gain.setValueAtTime(0.22, t + repLen * 0.6);
        g.gain.linearRampToValueAtTime(0, t + repLen * 0.95);
        o.connect(g).connect(c.destination);
        o.start(t);
        o.stop(t + repLen);
        activeSoundNodes.push(o);
      }
    }

    // ── Complete: triumphant repeating fanfare 5s ──
    function playContinuousComplete() {
      stopAllSounds();
      const c = ctx(), now = c.currentTime;
      const melody = [523.25, 659.25, 783.99, 1046.5];
      const dur = 5, noteLen = 0.35, gap = 0.1;
      let t = now, idx = 0;
      while (t < now + dur) {
        const o = c.createOscillator();
        const g = c.createGain();
        o.type = 'sine';
        o.frequency.value = melody[idx % melody.length];
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.28, t + 0.03);
        g.gain.setValueAtTime(0.28, t + noteLen - 0.05);
        g.gain.linearRampToValueAtTime(0, t + noteLen);
        o.connect(g).connect(c.destination);
        o.start(t);
        o.stop(t + noteLen + 0.01);
        activeSoundNodes.push(o);
        t += noteLen + gap;
        idx++;
      }
    }

    // ═══════════════════════════════════════════
    //  SCREEN PULSE
    // ═══════════════════════════════════════════
    let pulseTimer = null;

    function triggerPulse(color) {
      const el = document.getElementById('pulseRing');
      el.classList.remove('active');
      el.style.setProperty('--pulse-color', color);
      // Force reflow to restart animation
      void el.offsetWidth;
      el.classList.add('active');
      if (pulseTimer) clearTimeout(pulseTimer);
      pulseTimer = setTimeout(() => el.classList.remove('active'), 5200);
    }

    // ═══════════════════════════════════════════
    //  THEME
    // ═══════════════════════════════════════════
    function setAccent(color, glow) {
      const r = document.documentElement.style;
      r.setProperty('--accent', color);
      r.setProperty('--accent-glow', glow);
    }

    const THEMES = {
      warmup:   () => setAccent('var(--warmup-color)',   'var(--warmup-glow)'),
      fast:     () => setAccent('var(--fast-color)',      'var(--fast-glow)'),
      slow:     () => setAccent('var(--slow-color)',      'var(--slow-glow)'),
      cooldown: () => setAccent('var(--cooldown-color)',  'var(--cooldown-glow)'),
      done:     () => setAccent('var(--done-color)',      'var(--done-glow)'),
    };

    // Resolved hex colors for pulse (CSS vars don't work in box-shadow animation)
    const PULSE_COLORS = {
      warmup:   '#f59e0b',
      fast:     '#ef4444',
      slow:     '#3b82f6',
      cooldown: '#06b6d4',
      done:     '#10b981',
    };

    // ═══════════════════════════════════════════
    //  PHASE STRIP
    // ═══════════════════════════════════════════
    function updateStrip() {
      const w = document.getElementById('strip-warmup');
      const t = document.getElementById('strip-training');
      const c = document.getElementById('strip-cooldown');
      w.className = t.className = c.className = 'phase-strip-item';
      if (phase === 'warmup') { w.classList.add('active'); }
      else if (phase === 'fast' || phase === 'slow') { w.classList.add('completed'); t.classList.add('active'); }
      else if (phase === 'cooldown') { w.classList.add('completed'); t.classList.add('completed'); c.classList.add('active'); }
      else if (phase === 'done') { w.classList.add('completed'); t.classList.add('completed'); c.classList.add('completed'); }
    }

    // ═══════════════════════════════════════════
    //  SETTINGS
    // ═══════════════════════════════════════════
    function adj(key, delta) {
      if (running) return;
      const [mn, mx] = LIM[key];
      let v = S[key] + delta;
      v = Math.max(mn, Math.min(mx, v));
      S[key] = key.includes('Speed') ? Math.round(v * 10) / 10 : Math.round(v);
      renderSettings();
      if (phase === 'idle') renderIdle();
    }

    function fmtT(s) { return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`; }
    function fmtBig(s) { return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; }

    function renderSettings() {
      const $ = id => document.getElementById(id);
      $('v-warmupSpeed').textContent = S.warmupSpeed.toFixed(1);
      $('v-warmupTime').textContent  = fmtT(S.warmupTime);
      $('v-fastSpeed').textContent   = S.fastSpeed.toFixed(1);
      $('v-fastTime').textContent    = fmtT(S.fastTime);
      $('v-slowSpeed').textContent   = S.slowSpeed.toFixed(1);
      $('v-slowTime').textContent    = fmtT(S.slowTime);
      $('v-cycles').textContent      = S.cycles;
      $('v-cooldownSpeed').textContent = S.cooldownSpeed.toFixed(1);
      $('v-cooldownTime').textContent  = fmtT(S.cooldownTime);
    }

    function renderIdle() {
      document.getElementById('timeDisplay').textContent = fmtBig(S.warmupTime);
      document.getElementById('speedDisplay').textContent = S.warmupSpeed.toFixed(1);
    }

    // ═══════════════════════════════════════════
    //  DISPLAY
    // ═══════════════════════════════════════════
    function render() {
      document.getElementById('timeDisplay').textContent = fmtBig(timeLeft);
      let spd = 0, pName = '', mName = '', showCy = false;
      switch (phase) {
        case 'warmup':   spd = S.warmupSpeed;   pName = 'Warm Up';   THEMES.warmup();   break;
        case 'fast':     spd = S.fastSpeed;      pName = 'Training';  mName = 'Sprint';    showCy = true; THEMES.fast();   break;
        case 'slow':     spd = S.slowSpeed;      pName = 'Training';  mName = 'Recovery';  showCy = true; THEMES.slow();   break;
        case 'cooldown': spd = S.cooldownSpeed;  pName = 'Cool Down'; THEMES.cooldown(); break;
      }
      document.getElementById('speedDisplay').textContent = spd.toFixed(1);
      document.getElementById('phaseLabel').textContent = pName;
      document.getElementById('modeLabel').textContent = mName || '\u00A0';
      const ci = document.getElementById('cycleInfo');
      if (showCy) {
        ci.style.display = 'block';
        document.getElementById('curCycle').textContent = curCycle;
        document.getElementById('totCycles').textContent = S.cycles;
      } else {
        ci.style.display = 'none';
      }
      const pct = totalPhaseTime > 0 ? (timeLeft / totalPhaseTime) * 100 : 100;
      document.getElementById('progressBar').style.width = pct + '%';
      updateStrip();
    }

    // ═══════════════════════════════════════════
    //  PHASE TRANSITIONS
    // ═══════════════════════════════════════════
    function startPhase(p) {
      phase = p;
      switch (p) {
        case 'warmup':
          timeLeft = S.warmupTime;
          totalPhaseTime = S.warmupTime;
          curCycle = 0;
          playContinuousWarmup();
          triggerPulse(PULSE_COLORS.warmup);
          break;
        case 'fast':
          curCycle++;
          timeLeft = S.fastTime;
          totalPhaseTime = S.fastTime;
          if (curCycle === 1) {
            playContinuousTrainingStart();
          } else {
            playContinuousFast();
          }
          triggerPulse(PULSE_COLORS.fast);
          break;
        case 'slow':
          timeLeft = S.slowTime;
          totalPhaseTime = S.slowTime;
          playContinuousSlow();
          triggerPulse(PULSE_COLORS.slow);
          break;
        case 'cooldown':
          timeLeft = S.cooldownTime;
          totalPhaseTime = S.cooldownTime;
          playContinuousCooldownStart();
          triggerPulse(PULSE_COLORS.cooldown);
          break;
        case 'done':
          finish();
          return;
      }
      render();
    }

    function next() {
      switch (phase) {
        case 'warmup':  startPhase('fast'); break;
        case 'fast':    startPhase('slow'); break;
        case 'slow':    curCycle >= S.cycles ? startPhase('cooldown') : startPhase('fast'); break;
        case 'cooldown': startPhase('done'); break;
      }
    }

    function tick() {
      if (!running) return;
      timeLeft--;
      if (timeLeft <= 0) next();
      else render();
    }

    // ═══════════════════════════════════════════
    //  CONTROLS
    // ═══════════════════════════════════════════
    const playIcon  = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>';
    const pauseIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';

    function startTimer() {
      const btn = document.getElementById('btnStart');
      if (running) {
        running = false;
        clearInterval(ticker);
        stopAllSounds();
        btn.innerHTML = playIcon + ' Resume';
        return;
      }
      ctx(); // ensure audio ready
      if (phase === 'idle' || phase === 'done') {
        t0 = Date.now();
        running = true;
        startPhase('warmup');
        document.getElementById('settingsPanel').classList.add('disabled');
        document.getElementById('btnReset').style.display = '';
      } else {
        running = true;
      }
      btn.innerHTML = pauseIcon + ' Pause';
      clearInterval(ticker);
      ticker = setInterval(tick, 1000);
    }

    function resetTimer() {
      running = false;
      clearInterval(ticker);
      stopAllSounds();
      phase = 'idle';
      timeLeft = totalPhaseTime = curCycle = 0;
      document.getElementById('settingsPanel').classList.remove('disabled');
      document.getElementById('btnReset').style.display = 'none';
      document.getElementById('btnStart').innerHTML = playIcon + ' Start';
      document.getElementById('phaseLabel').textContent = 'Warm Up';
      document.getElementById('modeLabel').textContent = '\u00A0';
      document.getElementById('cycleInfo').style.display = 'none';
      document.getElementById('progressBar').style.width = '100%';
      document.getElementById('pulseRing').classList.remove('active');
      THEMES.warmup();
      updateStrip();
      renderIdle();
    }

    function finish() {
      running = false;
      clearInterval(ticker);
      phase = 'done';
      playContinuousComplete();
      triggerPulse(PULSE_COLORS.done);
      THEMES.done();
      updateStrip();
      const elapsed = Math.round((Date.now() - t0) / 1000);
      document.getElementById('statTime').textContent = fmtBig(elapsed);
      document.getElementById('statCycles').textContent = S.cycles;
      setTimeout(() => document.getElementById('doneScreen').classList.add('active'), 2500);
    }

    function fullReset() {
      document.getElementById('doneScreen').classList.remove('active');
      resetTimer();
    }

    // ═══════════════════════════════════════════
    //  INIT
    // ═══════════════════════════════════════════
    document.getElementById('btnStart').addEventListener('click', startTimer);
    document.getElementById('btnReset').addEventListener('click', resetTimer);
    renderSettings();
    renderIdle();
  </script>
</body>
</html>
